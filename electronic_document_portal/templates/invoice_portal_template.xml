<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <template id="portal_my_home_menu_invoice_inherit" name="Portal layout: invoice menu entries (extended)"
        inherit_id="account.portal_my_home_menu_invoice" priority="35">
        <xpath expr="//li[contains(@t-if, 'invoice')]" position="replace">
            <li t-if="page_name == 'invoice'" 
                t-attf-class="breadcrumb-item #{'active ' if not invoice else ''}">
                <a t-if="invoice" t-attf-href="/my/invoices?{{ keep_query() }}">Facturas</a>
                <t t-else="">Facturas</t>
            </li>

            <li t-if="page_name == 'refund'" 
                t-attf-class="breadcrumb-item #{'active ' if not invoice else ''}">
                <a t-if="invoice" t-attf-href="/my/refunds?{{ keep_query() }}">Notas de Crédito</a>
                <t t-else="">Notas de Crédito</t>
            </li>

            <li t-if="page_name == 'debit_note'" 
                t-attf-class="breadcrumb-item #{'active ' if not invoice else ''}">
                <a t-if="invoice" t-attf-href="/my/debit_notes?{{ keep_query() }}">Notas de Débito</a>
                <t t-else="">Notas de Débito</t>
            </li>

            <li t-if="page_name == 'liquidation'" 
                t-attf-class="breadcrumb-item #{'active ' if not invoice else ''}">
                <a t-if="invoice" t-attf-href="/my/liquidations?{{ keep_query() }}">Liquidaciones de Compras</a>
                <t t-else="">Liquidaciones de Compras</t>
            </li>
        </xpath>
    </template>

    <template id="portal_my_invoices_custom" name="Mis Facturas" inherit_id="account.portal_my_invoices">
        <!-- Cambia el título de la página anteriormente estaba como My Invoices and Payments -->
        <xpath expr="//t[@t-call='portal.portal_layout']" position="before">
            <t t-set="title">Mis Facturas</t>
        </xpath>
        <xpath expr="//t[@t-if='not invoices']" position="replace">
            <t t-if="not invoices">
                <div class="alert alert-info text-center" style="margin: 20px; padding: 15px; border-radius: 10px;">
                    <i class="fa fa-info-circle" style="font-size: 24px; margin-bottom: 10px;"></i>
                    <h4>No hay facturas disponibles</h4>
                    <p>Parece que no tienes facturas asociadas a tu cuenta en este momento.</p>
                    <a href="/my/home" class="btn btn-primary" style="margin-top: 10px;">Volver al Panel</a>
                </div>
            </t>
        </xpath>

        <xpath expr="//t[@t-if='invoices']" position="replace">
            <t t-if="invoices" t-call="portal.portal_table">
                <thead>
                    <tr class="active">
                        <th>Factura #</th>
                        <th>Cliente</th>
                        <th class="text-center">Fecha de Emisión</th>
                        <th class='text-center d-none d-md-table-cell'>Fecha de Vencimiento</th>
                        <th class="text-center">Estado de Envío</th>
                        <th class="text-center">Estado de Autorización</th>
                        <th class="text-center">Importe Adeudado</th>
                        <th class="text-center"><span class="fa fa-download fa-lg"></span></th>
                    </tr>
                </thead>
                <tbody>
                    <t t-foreach="invoices" t-as="invoice">
                        <tr>
                            <td>
                                <a t-att-href="invoice.get_portal_url()" t-att-title="invoice.name">
                                    <t t-esc="invoice.name" t-if="invoice.name != '/'"/>
                                    <em t-else="">Borrador de Factura</em>
                                </a>
                            </td>
                            <td><span t-esc="invoice.partner_id.name.title()"/></td>
                            <td class="text-center"><span t-field="invoice.invoice_date"/></td>
                            <td class='text-center d-none d-md-table-cell'><span t-field="invoice.invoice_date_due"/></td>
                            <td class="tx_status text-center">
                                <t t-call="electronic_document_portal.email_state_template">
                                    <t t-set="is_sent" t-value="invoice.xml_data_id.send_mail" />
                                </t>
                            </td>
                            <td class="tx_status text-center">
                                <t t-call="electronic_document_portal.sri_state_template">
                                    <t t-set="state_sri" t-value="invoice.state_sri"/>
                                </t>
                            </td>
                            <td class="text-center"><span t-esc="-invoice.amount_residual if invoice.move_type == 'out_refund' else invoice.amount_residual" t-options='{"widget": "monetary", "display_currency": invoice.currency_id}'/></td>
                            <td class="text-center">
                                <span class="pdf-icon" style="margin: 5px;">
                                    <a class="fa fa-file-pdf-o fa-lg" t-att-href="invoice.get_portal_url(report_type='pdf', download=True)" style="color: red; font-weight: bold;"></a>
                                </span>
                                <span class="xml-icon" style="margin: 5px;">
                                    <a class="fa fa-file-code-o fa-lg" t-att-href="invoice.get_portal_url(report_type='xml', download=True)" style="color: green; font-weight: bold;"></a>
                                </span>
                            </td>
                        </tr>
                    </t>
                </tbody>
            </t>
        </xpath>
    </template>

    <template id="portal_invoice_page" name="template_name" inherit_id="account.portal_invoice_page">
        <xpath expr="//t[@t-set='backend_url']" position="replace">
            <t t-if="invoice.move_type == 'out_refund'">
                
            </t>
            <t t-if="invoice.move_type == 'out_refund'">
                <t t-set="backend_url" t-value="'/web#model=%s&amp;id=%s&amp;action=%s&amp;view_type=form' % (invoice._name, invoice.id, invoice.env.ref('account.action_move_out_refund_type').id)"/>
            </t>
            <t t-elif="invoice.debit_note == True">
                <t t-set="backend_url" t-value="'/web#model=%s&amp;id=%s&amp;action=%s&amp;view_type=form' % (invoice._name, invoice.id, invoice.env.ref('ec_account_edi.action_debit_note_customer_tree').id)"/>
            </t>
            <t t-elif="invoice.liquidation == True">
                <t t-set="backend_url" t-value="'/web#model=%s&amp;id=%s&amp;action=%s&amp;view_type=form' % (invoice._name, invoice.id, invoice.env.ref('ec_account_edi.action_invoice_purchase_liquidation_tree').id)"/>
            </t>
            <t t-else="">
                <t t-set="backend_url" t-value="'/web#model=%s&amp;id=%s&amp;action=%s&amp;view_type=form' % (invoice._name, invoice.id, invoice.env.ref('account.action_move_out_invoice_type').id)"/>
            </t>
            
        </xpath>
        <xpath expr="//div[@class='o_download_pdf btn-toolbar flex-sm-nowrap']" position="replace">
            <div class="o_download_pdf btn-toolbar flex-sm-nowrap">
                <div class="btn-group  flex-grow-1 me-1 mb-1">
                    <a class="btn btn-danger btn-block o_download_btn" t-att-href="invoice.get_portal_url(report_type='pdf', download=True)" title="RIDE"><i class="fa fa-download"/> RIDE</a>
                </div>
                <div class="btn-group  flex-grow-1 me-1 mb-1">
                    <a class="btn btn-success btn-block o_download_btn" t-att-href="invoice.get_portal_url(report_type='xml', download=True)" title="XML"><i class="fa fa-download"/> XML</a>
                </div>
                <div class="btn-group flex-grow-1 mb-1">
                    <a class="btn btn-secondary btn-block o_print_btn o_portal_invoice_print" t-att-href="invoice.get_portal_url(report_type='pdf')" id="print_invoice_report" title="Print" target="_blank"><i class="fa fa-print"/> Print</a>
                </div>
            </div>
        </xpath>

        <xpath expr="//div[@class='small']" position="attributes">
            <attribute name="class">d-none</attribute>
        </xpath>

        <xpath expr="//li[@t-if='invoice.invoice_user_id']" position="attributes">
            <attribute name="class">d-none</attribute>
        </xpath>

        <xpath expr="//div[@id='invoice_communication']" position="attributes">
            <attribute name="class">d-none</attribute>
        </xpath>

    </template>

</odoo>
